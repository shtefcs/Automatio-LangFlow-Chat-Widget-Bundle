(() => {
  class ChatClient {
    constructor(hostUrl, apiKey, flowId) {
      this.hostUrl = hostUrl;
      this.apiKey = apiKey;
      this.flowId = flowId;
      this.callbacks = {
        onMessage: null,
        onStatusChange: null
      };
      console.log('[ChatClient] Initialized with:', { hostUrl, flowId });
    }

    setCallbacks(callbacks) {
      this.callbacks = { ...this.callbacks, ...callbacks };
    }

    async connect() {
      console.log('[ChatClient] Connecting...');
      try {
        await this.testConnection();
        if (this.callbacks.onStatusChange) {
          this.callbacks.onStatusChange('CONNECTED');
        }
        return true;
      } catch (error) {
        console.error('[ChatClient] Connection failed:', error);
        if (this.callbacks.onStatusChange) {
          this.callbacks.onStatusChange('DISCONNECTED');
        }
        return false;
      }
    }

    async testConnection() {
      console.log('[ChatClient] Testing connection...');
      const headers = new Headers();
      headers.append('Content-Type', 'application/json');
      headers.append('apikey', this.apiKey);

      const response = await fetch(`${this.hostUrl}/health`, {
        method: 'GET',
        headers: headers
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();
    }

    async sendMessage(message) {
      console.log('[ChatClient] Sending message:', message);
      const headers = new Headers();
      headers.append('Content-Type', 'application/json');
      headers.append('apikey', this.apiKey);

      try {
        // Using the correct LangFlow API endpoint and request format
        const response = await fetch(`${this.hostUrl}/api/v1/process/${this.flowId}`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            inputs: {
              question: message
            },
            conversation_id: null,
            history: []
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('[ChatClient] Received response:', data);
        
        if (this.callbacks.onMessage) {
          this.callbacks.onMessage(data);
        }
        
        return data;
      } catch (error) {
        console.error('[ChatClient] Error sending message:', error);
        throw error;
      }
    }
  }

  // Rest of the code remains the same...
  // [Previous LangFlowChat class implementation remains unchanged]

  class LangFlowChat extends HTMLElement {
    // ... [Previous implementation remains unchanged] ...

    handleMessage(response) {
      console.log('[LangFlowChat] Handling message:', response);
      // Update to handle the new response format
      if (response.result && response.result.answer) {
        this.addMessage('assistant', response.result.answer);
      } else if (response.result) {
        this.addMessage('assistant', response.result);
      }
    }

    // ... [Rest of the implementation remains unchanged] ...
  }

  // Register the custom element
  customElements.define('langflow-chat', LangFlowChat);
  console.log('[Bundle] LangFlow Chat Widget loaded and registered');
})();
